---
title: "fire_analysis"
author: "Anna J Holmquist"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/DATA/data') 
# How do we make this relative for reproducibility?
```

```{r libraries}

library(tidyverse)
library(reshape2)
library(ape)
library(vegan)
library(BAT)
library(venn)

```

```{r data}
getwd()
# Produced from cleanup
df_97 <- read.csv("mco_97_wsites.csv")
sites <- read.csv("site_data.csv")

```

Corrected BLAST (should go in data clean up file?)
```{r}

family <- vector()
genus <- vector()
species <- vector()

for (i in 1:length(df_97$family)){
  if (df_97$percent[i] > 99){
    family[i] <- df_97$family[i]
    genus[i] <- df_97$genus_blast[i]
    species[i] <- df_97$species_blast[i]
  } else if (df_97$percent[i] > 97){
    family[i] <- df_97$family[i]
    genus[i] <- df_97$genus_blast[i]
    species[i] <- NA
  } else if (df_97$percent[i] > 95){
    family[i] <- df_97$family[i]
    genus[i] <- NA
    species[i] <- NA
  } else {
    family[i] <- NA
    genus[i] <- NA
    species[i] <- NA
  }
}

df_97$family <- family
df_97$genus <- genus
df_97$species <- species

```

Add site data (should go in data clean up file?)
```{r} 

sites <- df_97 %>%
  group_by(sample_name) %>%
  filter(row_number() == 1) %>%
  select(site, year, sample_name, site_name, reserve, status, habitat) %>%
  ungroup()
df_97 <- df_97 %>%
  mutate(site_name = toupper(paste0(reserve, status, site))) 
  left_join(sites, by = c("site_name" = "site")) %>%
  ungroup()

write.csv(sites, "site_data.csv", row.names = F)
write.csv(df_97, "mco_97_wsites.csv", row.names = F)

```

Taxonomy summary
```{r taxonomy summary}

df_97 %>%
  summarise(fam = n_distinct(family),
            gen = n_distinct(genus),
            sp = n_distinct(species),
            order = n_distinct(order))

# Venn
families <- list(
  Burned = unique(df_97$family[df_97$status == "Burn"
                               & !is.na(df_97$family)]),
  Unburned = unique(df_97$family[df_97$status == "Unburn"
                               & !is.na(df_97$family)])
  )

venn(families, opacity = 0.4, zcolor = c("#d0681e","#1e74d0"))

# Not included currently
genera <- list(
  Burned = unique(df_97$genus[df_97$status == "Burn"
                               & !is.na(df_97$family)]),
  Unburned = unique(df_97$genus[df_97$status == "Unburn"
                               & !is.na(df_97$family)])
  )

venn(genera, opacity = 0.4, zcolor = c("#d0681e","#1e74d0"))

# Bars
df_97 %>%
  filter(!is.na(order)) %>%
  group_by(order, status, year) %>%
  summarise(n = n_distinct(otu)) %>%
  ggplot() +
  geom_bar(aes(order, n, fill = status), 
           stat = "identity", position = "dodge") +
  facet_grid(~year) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) 

```

Hypothesis 1: Species richness will not be different between burned and unburned sites
```{r richness, alpha diversity}

# Create dataframe with reads by OTU at each site and year
otu_counts <- 
  df_97 %>%
  group_by(sample_name, otu) %>%
  # Remove multiple rows
  filter(row_number() == 1) %>%
  # Use reads across all replicates
  summarise(otu_count = sum(rep_combined)) %>%
  ungroup()

# Create Hellinger, incidence matrix
otu_mat <-
  otu_counts %>%
  select(sample_name, otu, otu_count) %>%
  acast(sample_name ~ otu, fill = 0)

hell_mat <- decostand(otu_mat, method = "hellinger")
inc_mat <- otu_mat
inc_mat[inc_mat > 0] <- 1

# Calculate alpha diversity
diversity_shannon <- as.data.frame(vegan::diversity(hell_mat, index = "shannon")) %>%
    rownames_to_column(var = "id")
colnames(diversity_shannon) <- c("sample_name", "div")

diversity_simpson <- as.data.frame(vegan::diversity(hell_mat, index = "simpson")) %>%
    rownames_to_column(var = "id")
colnames(diversity_simpson) <- c("sample_name", "div")

diversity_rich <- as.data.frame(BAT::alpha(hell_mat)) %>%
  rownames_to_column(var = "id")
colnames(diversity_rich) <- c("sample_name", "div")

# Join diversity with site data
diversity_rich <- 
  diversity_rich %>%
  left_join(sites, by = "sample_name")

diversity_shannon <- 
  diversity_shannon %>%
  left_join(sites, by = "sample_name")

diversity_simpson <- 
  diversity_simpson %>%
  left_join(sites, by = "sample_name")

# Test variance
var.test(diversity_rich$div[diversity_rich$status == "Burn"], 
         diversity_rich$div[diversity_rich$status == "Unburn"]) 

var.test(diversity_shannon$div[diversity_shannon$status == "Burn"], 
         diversity_shannon$div[diversity_shannon$status == "Unburn"])

var.test(diversity_simpson$div[diversity_simpson$status == "Burn"], 
         diversity_simpson$div[diversity_simpson$status == "Unburn"]) 

# T-test
t_status1 <- 
  t.test(diversity_rich$div[diversity_rich$status == "Burn"], 
         diversity_rich$div[diversity_rich$status == "Unburn"],
       var.equal = TRUE)
rich_p <- t_status1$p.value

t_status2 <- 
  t.test(diversity_shannon$div[diversity_shannon$status == "Burn"], 
         diversity_shannon$div[diversity_shannon$status == "Unburn"],
       var.equal = TRUE)
shan_p <- t_status2$p.value

t_status3 <- 
  t.test(diversity_simpson$div[diversity_simpson$status == "Burn"], 
         diversity_simpson$div[diversity_simpson$status == "Unburn"],
       var.equal = TRUE)
simp_p <- t_status3$p.value

# Mood's Median
library(coin)

median_test(div ~ as.factor(status), diversity_rich)
median_test(div ~ as.factor(status), diversity_shannon)
median_test(div ~ as.factor(status), diversity_simpson)


# Plots c("#d0681e","#1e74d0")
p1 <- ggplot(diversity_rich, aes(status, div)) +
  geom_boxplot(aes(fill = status), alpha = 0.6) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun = mean, geom = "point", shape = 24, size = 4, 
               color = "black", fill = "white" ) +
  annotate(geom="text", 
           label = paste0("p-value: ", round(t_status1$p.value, digits = 3)), 
           x = 2, y = 22) +
  scale_fill_manual(values = c("#d0681e","#1e74d0")) +
  theme_minimal()

p2 <- ggplot(diversity_shannon, aes(status, div)) +
  geom_boxplot(aes(fill = status), alpha = 0.6) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun = mean, geom = "point", shape = 24, size = 4, 
               color = "black", fill = "white" ) +
  annotate(geom="text", 
           label = paste0("p-value: ", round(t_status2$p.value, digits = 3)), 
           x = 2, y = 3.5) +
  scale_fill_manual(values = c("#d0681e","#1e74d0")) +
  theme_minimal()

p3 <- ggplot(diversity_simpson, aes(status, div)) +
  geom_boxplot(aes(fill = status), alpha = 0.6) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun = mean, geom = "point", shape = 24, size = 4, 
               color = "black", fill = "white" ) +
  annotate(geom="text", 
           label = paste0("p-value: ", round(t_status3$p.value, digits = 3)), 
           x = 2, y = 1) + 
  scale_fill_manual(values = c("#d0681e","#1e74d0")) +
  theme_minimal()

x <- ggpubr::ggarrange(p1, p2, p3,
                       ncol = 3,
                       common.legend = TRUE,
                       labels = c("Richness",
                                  "Shannon",
                                  "Simpson"))
# T-test by year
t_status1 <- 
  t.test(diversity_rich$div[diversity_rich$year == "pan2020"], 
         diversity_rich$div[diversity_rich$year == "pan2021"],
       var.equal = TRUE)

t_status2 <- 
  t.test(diversity_shannon$div[diversity_rich$year == "pan2020"], 
         diversity_shannon$div[diversity_rich$year == "pan2021"],
       var.equal = TRUE)

t_status3 <- 
  t.test(diversity_simpson$div[diversity_rich$year == "pan2020"], 
         diversity_simpson$div[diversity_rich$year == "pan2021"],
       var.equal = TRUE)

# Figure
# Facet by year, fill by status 
alpha_bar1 <- 
  diversity_rich %>%
  ggplot(aes(year, div)) + 
  geom_boxplot(aes(fill = year), alpha = 0.7) +
  geom_jitter(aes(color = year), alpha = 0.5) +
  theme_minimal() +
  stat_summary(fun = mean, geom = "point", shape = 24, size= 4, 
               color ="black", fill="white") 

alpha_bar2 <- 
  diversity_shannon %>% 
  ggplot(aes(year, div)) + 
  geom_boxplot(aes(fill = year), alpha = 0.7) +
  geom_jitter(aes(color = year), alpha = 0.5) +
  theme_minimal() +
  stat_summary(fun = mean, geom = "point", shape = 24, size= 4, 
               color ="black", fill="white") +
  annotate(geom = "text", 
           label = paste0("p-value: ", signif(t_status2$p.value, digits = 3)), 
           x = 1, y = 3.5) +
  theme_minimal()

alpha_bar3 <- 
  diversity_simpson %>%
  ggplot(aes(year, div)) + 
  geom_boxplot(aes(fill = year), alpha = 0.7) +
  geom_jitter(aes(color = year), alpha = 0.5) +
  theme_minimal() +
  stat_summary(fun = mean, geom = "point", shape = 24, size= 4, 
               color ="black", fill="white") 

x2 <- ggpubr::ggarrange(alpha_bar1, alpha_bar2, alpha_bar3,
                       ncol = 3,
                       labels = c("Richness",
                                  "Shannon",
                                  "Simpson"), common.legend = T)
x3 <- ggpubr::ggarrange(p2, alpha_bar2,
                        labels = c("Burn versus Unburn",
                                  "Fall versus Spring"))

diversity_shannon %>% 
  filter(!is.na(habitat)) %>%
  ggplot(aes(habitat, div)) + 
  geom_boxplot(aes(fill = habitat), alpha = 0.7) +
  geom_jitter(aes(color = habitat), alpha = 0.5) +
  facet_wrap(~ year) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45)) 

```

Community analysis - 97
```{r calculate distances}

# Create dataframe with reads by OTU at each site and year
otu_counts_97 <- 
  df_97 %>%
  filter(reserve != "QR") %>%
  filter(habitat %in% c("Grassland", "Scrub", 
                        "Oak Woodland", "Chamise")) %>%
  group_by(sample_name, otu) %>%
  # Remove multiple rows
  filter(row_number() == 1) %>%
  # Use reads across all replicates
  summarise(otu_count = sum(rep_combined)) %>%
  ungroup() 

# Create Hellinger, incidence matrix
otu97_mat <-
  otu_counts_97 %>%
  select(sample_name, otu, otu_count) %>%
  acast(sample_name ~ otu, fill = 0)

hell97_mat <- decostand(otu97_mat, method = "hellinger")

inc97_mat <- hell97_mat
inc97_mat[inc97_mat > 0] <- 1

```

Hypothesis 2: Burned and unburned sites will differ compositionally, using MOTUs
```{r ordination, adonis, betadis}

dhell_mat <- hell97_mat
dinc_mat <- inc97_mat

# NMDS exploration - Hellinger distances
x <- .Random.seed
nmds <- metaMDS(dhell_mat, distance = "euclidean", 
                trymax = 100) # Only did 100 because it fails regardless with outliers
nmds_df <- 
  as_tibble(nmds$points, rownames = "sample_name") %>%
  left_join(df_97, by = "sample_name")

nmdseuc <- 
  nmds_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  geom_point(aes(color = status), size = 1) +
  geom_text(aes(label = sample_name, color = status), size = 1) +
  theme_minimal()

nmds <- metaMDS(dinc_mat, trymax = 100, distance = "jaccard")
nmds_df <- 
  as_tibble(nmds$points, rownames = "sample_name") %>%
  left_join(df_97, by = "sample_name")
nmdsjacc <- 
  nmds_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  geom_point(aes(color = status), size = 1) +
  geom_text(aes(label = sample_name, color = status), size = 1) +
  theme_minimal()

# Dataframe for permanova
permanova_df <-
  df_97 %>%
  group_by(sample_name) %>%
  filter(row_number() == 1) %>%
  filter(sample_name %in% rownames(as.matrix(dhell_mat)))

# PERMANOVA
adonis_total_hell <- adonis2(dhell_mat ~ year*status*habitat*reserve,
                        method = "euclidean", data = permanova_df, 
                        permutations = 1000)
adonis_total_jac <- adonis2(dinc_mat ~ year*status*habitat*reserve,
                        method = "jaccard", data = permanova_df, 
                        permutations = 1000)

# PERMDISP

jac <- vegdist(dinc_mat, method = "jaccard")
euc <- vegdist(dhell_mat, method = "euclidean")

anova(betadisper(jac, permanova_df$status)) 
anova(betadisper(euc, permanova_df$status)) 

# Without outliers
outliers <- c("pan2021_BC_S01_Unburn",
              "pan2020_ML_O01_Burn",
              "pan2021_HT_G04_Burn")

mat_outlier_i <- 
  subset(dinc_mat, !rownames(dinc_mat) %in% outliers)
  
mat_outlier_h <- 
  subset(dhell_mat, !rownames(dhell_mat) %in% outliers)

nmds_outlier_jac <- metaMDS(mat_outlier_i, dist = "jaccard", trymax = 1000,
                        k = 3, noshare = TRUE)
nmds_outlier_euc <- metaMDS(mat_outlier_h, dist = "euclidean", trymax = 1000, 
                            k = 3, noshare = TRUE)

nmds_df <- 
  as_tibble(nmds_outlier_jac$points, rownames = "sample_name") %>%
  left_join(df_97, by = "sample_name")

nmds_jac <- 
  nmds_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  #geom_text(aes(label = sample_name), size = 1) +
  geom_point(aes(color = status), size = 2, alpha = 0.5) +
  stat_ellipse(type = "euclid") +
  scale_color_manual(values = c("#d0681e","#1e74d0")) +
  theme_minimal()

nmds_df <- 
  as_tibble(nmds_outlier_euc$points, rownames = "sample_name") %>%
  left_join(df_97, by = "sample_name")

nmds_euc <- 
  nmds_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  #geom_text(aes(label = sample_name), size = 1) +
  geom_point(aes(color = status), size = 2, alpha = 0.5) +
  stat_ellipse(type = "euclid") +
  scale_color_manual(values = c("#d0681e","#1e74d0")) +
  theme_minimal()

# Dataframe for permanova
permanova_df <-
  df_97 %>%
  group_by(sample_name) %>%
  filter(row_number() == 1) %>%
  filter(sample_name %in% rownames(as.matrix(mat_outlier_h)))

# PERMDISP

jac <- vegdist(mat_outlier_i, method = "jaccard")
euc <- vegdist(mat_outlier_h, method = "euclidean")

anova(betadisper(jac, permanova_df$status))
anova(betadisper(euc, permanova_df$status))

# Are there significant differences by status, habitat, reserve, year, etc?
adonis_total_hell <- adonis2(mat_outlier_h ~ year*status*habitat*reserve,
                        method = "euclidean", data = permanova_df, 
                        permutations = 1000)
adonis_total_inc <- adonis2(mat_outlier_i ~ year*status*habitat*reserve,
                        method = "euclidean", data = permanova_df, 
                        permutations = 1000)

```

Distances
```{r}
distances <- 
  read.csv("fire_dist.csv") %>%
  rename(site1 = InputID,
         site2 = TargetID,
         distance = Distance) %>%
  mutate(site1 = gsub(" ", "", site1),
         site2 = gsub(" ", "", site2))
```

Beta diversity
```{r calculate beta diversity}
beta_bat <- beta(dhell_mat, func = "euclidean")
beta_total <- as.matrix(beta_bat$Btotal)
beta_repl <- as.matrix(beta_bat$Brepl)
beta_rich <- as.matrix(beta_bat$Brich)

# Eliminate double comparisons by making upper tri 0
beta_total[upper.tri(beta_total)] <- 0
beta_repl[upper.tri(beta_repl)] <- 0
beta_rich[upper.tri(beta_rich)] <- 0

beta_total <- 
  # Melt into DF
  melt(beta_total) %>%
  # Remove 0 values - self comparisons, or reverse comparisons
  filter(value != 0) %>%
  left_join(sites, by = c("Var1" = "sample_name")) %>%
  left_join(sites, by = c("Var2" = "sample_name")) %>%
  mutate(beta_type = "total")

beta_repl <- 
  # Melt into DF
  melt(beta_repl) %>%
  # Remove 0 values - self comparisons, or reverse comparisons
  filter(value != 0) %>%
  left_join(sites, by = c("Var1" = "sample_name")) %>%
  left_join(sites, by = c("Var2" = "sample_name")) %>%
  mutate(beta_type = "replacement")

beta_rich <- 
  # Melt into DF
  melt(beta_rich) %>%
  # Remove 0 values - self comparisons, or reverse comparisons
  filter(value != 0) %>%
  left_join(sites, by = c("Var1" = "sample_name")) %>%
  left_join(sites, by = c("Var2" = "sample_name")) %>%
  mutate(beta_type = "lossgain")

```

Beta against distances 
```{r}
beta_all <- rbind(beta_total,
                  beta_repl,
                  beta_rich) %>%
  rename(site1 = site_name.x,
         site2 = site_name.y) %>%
  left_join(distances, by = c("site1", "site2"))


within <- beta_all %>%
  filter(reserve.x == reserve.y
         & habitat.x == habitat.y 
         & year.x == year.y)

btwn <- beta_all %>%
    filter(reserve.x != reserve.y 
         & habitat.x == habitat.y 
         & year.x == year.y)

within %>%
  filter(distance < 6000) %>%
  ggplot(aes(distance, value)) +
  geom_point(aes(color = beta_type)) +
  geom_smooth(aes(color = beta_type), method = "lm") + 
  facet_grid(~year.x) +
  theme_minimal()

btwn %>%
  ggplot(aes(distance, value)) +
  geom_jitter(aes(color = beta_type)) +
  geom_smooth(aes(color = beta_type), method = "lm") +
  facet_wrap(~year.x) +
  facet_grid(habitat.x~year.x)

```

Hypothesis 3: Burn / unburn will become more compositionally similar from fall to spring - recovery (data combined)
```{r between site differences}

beta_narrowed <-
  beta_total %>%
  filter(reserve.x == reserve.y &
         habitat.x == habitat.y &
         year.x == year.y) %>%
  mutate(comparison = case_when(
    status.x == status.y & status.x == "Unburn" ~ "Unburned",
    status.x == status.y & status.x == "Burn" ~ "Burned",
    TRUE ~ "Between"
  ))
  
year_box <- 
  beta_narrowed %>%
  filter(comparison == "Between") %>%
  ggplot(aes(as.factor(year.x), value)) +
  geom_boxplot(aes(fill = as.factor(year.x)), alpha = 0.5) +
  geom_jitter(aes(fill = as.factor(year.x)), alpha = 0.3) +
  facet_grid(~comparison) +
  stat_summary(fun = mean, geom = "point", shape = 24, size = 4, 
               color = "black", fill = "white") +
  theme_minimal() 

t.test(value ~ year.x, data = beta_narrowed)

```

Hypothesis 4: varies by habitat
```{r grassland nmds/permanova}
dinc_mat <- inc97_mat
dhell_mat <- hell97_mat

# pan2021_HT_G01_Burn, pan2021_AN_G05_Burn, pan2020_ML_G01_Burn
grass_out <- c( "pan2021_HT_G01_Burn", "pan2021_AN_G05_Burn", 
                "pan2021_AN_G03_Unburn")

## 2020 ##
# Matrix
inc_grass <- subset(dinc_mat, rownames(dinc_mat) %in% 
                        sites$sample_name[sites$habitat == "Grassland" 
                                         & sites$year == "pan2020"])
inc_grass <- as.matrix(inc_grass[,colSums(inc_grass) != 0])
inc_grass <- subset(inc_grass, rownames(inc_grass) != "pan2020_ML_G01_Burn")

hell_grass <- subset(dhell_mat, rownames(dhell_mat) %in% 
                        sites$sample_name[sites$habitat == "Grassland"
                                         & sites$year == "pan2020"])
hell_grass <- as.matrix(hell_grass[,colSums(hell_grass) != 0])
hell_grass <- subset(hell_grass, rownames(hell_grass) != "pan2020_ML_G01_Burn")

# Ordination
set.seed(1)
grass_mds_inc <- metaMDS(inc_grass, distance = "jaccard", trymax = 100, 
                         k = 2)
grass_mds_hell <- metaMDS(hell_grass, distance = "euclidean", trymax = 1000, 
                          k = 2)

# Plot
grass_df <- 
  as_tibble(grass_mds_hell$points, rownames = "sample_name") %>%
  left_join(sites, by = "sample_name") 

grass_2020 <- 
  grass_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  geom_text(aes(label = sample_name), size = 1) +
  geom_point(aes(shape = status), size = 2) +
  stat_ellipse(type = "euclid") +
  theme_minimal() 

# Distance matrix
grass_dist <- vegdist(hell_grass)

# PERMANOVA / PERMDISP
perm_2020 <- adonis2(grass_dist~status, 
        sites[sites$sample_name %in% rownames(hell_grass),], 
        permutations = 1000)
anosim(hell_grass, distance = "euclidean",
       grouping = sites[sites$sample_name %in% rownames(hell_grass),]$status, 
       permutations = 1000)

dispr_2020 <- anova(betadisper(grass_dist, 
                 sites$status[sites$sample_name %in% rownames(hell_grass)]))

## 2021 ##
grass_out <- c( "pan2021_HT_G02_Unburn", "pan2021_HT_G04_Burn",
                "pan2021_AN_G03_Unburn")

# Matrix
inc_grass <- subset(dinc_mat, rownames(dinc_mat) %in% 
                        sites$sample_name[sites$habitat == "Grassland" 
                                         & sites$year == "pan2021"])
inc_grass <- as.matrix(inc_grass[,colSums(inc_grass) != 0])
inc_grass <- subset(inc_grass, !rownames(inc_grass) %in% grass_out)

hell_grass <- subset(dhell_mat, rownames(dhell_mat) %in% 
                        sites$sample_name[sites$habitat == "Grassland"
                                         & sites$year == "pan2021"])
hell_grass <- as.matrix(hell_grass[,colSums(hell_grass) != 0])
hell_grass <- subset(hell_grass, !rownames(hell_grass) %in% grass_out)

# Ordination
set.seed(1)
grass_mds_inc <- metaMDS(inc_grass, distance = "jaccard", trymax = 100, 
                         k = 2)
grass_mds_hell <- metaMDS(hell_grass, distance = "euclidean", trymax = 100, 
                          k = 2)

# Plot
grass_df <- 
  as_tibble(grass_mds_hell$points, rownames = "sample_name") %>%
  left_join(sites, by = "sample_name") 

grass_2021 <- 
  grass_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  geom_text(aes(label = sample_name), size = 1) +
  geom_point(aes(shape = status), size = 2) +
  stat_ellipse(type = "euclid") +
  theme_minimal() 

# Distance matrix
grass_dist <- vegdist(hell_grass)

# PERMANOVA / PERMDISP
perm_2021 <- adonis2(grass_dist~status, 
        sites[sites$sample_name %in% rownames(hell_grass),], 
        permutations = 1000)
anosim(hell_grass, distance = "euclidean",
       grouping = sites[sites$sample_name %in% rownames(hell_grass),]$status, 
       permutations = 1000)
dispr_2021 <- anova(betadisper(grass_dist, 
                 sites$status[sites$sample_name %in% rownames(hell_grass)]))

grass_nmds <- ggpubr::ggarrange(grass_2020, grass_2021)

# Richness

diversity_shannon %>% 
  filter(habitat == "Grassland") %>%
  ggplot(aes(status, div)) +
  geom_boxplot(aes(color = year)) +
  geom_jitter(alpha = 0.3) 

# Beta components

beta_all %>%
  filter(habitat.x == "Grassland" & habitat.y == "Grassland"
         & year.x == year.y & reserve.x == reserve.y) %>%
  mutate(comp = case_when(
    status.x == status.y & status.x == "Unburn" ~ "Unburned",
    status.x == status.y & status.x == "Burn" ~ "Burned",
    status.x != status.y ~ "Between"
  )) %>%
  filter(comp == "Between") %>%
  ggplot(aes(distance, value)) +
  geom_point(aes(color = beta_type)) +
  geom_smooth(method = "lm") +
  facet_grid(~year.x)

```

```{r scrub nmds/permanova}
site <- sites

# pan2021_HT_G01_Burn, pan2021_AN_G05_Burn, pan2020_ML_G01_Burn
scrub_out <- c( "pan2020_AN_S01_Burn", "pan2020_AN_S01_Unburn")

## 2020 ##
# Matrix
inc_scrub <- subset(dinc_mat, rownames(dinc_mat) %in% 
                        site$sample_name[site$habitat == "Scrub" 
                                         & site$year == "pan2020"])
inc_scrub <- as.matrix(inc_grass[,colSums(inc_grass) != 0])
inc_scrub <- subset(inc_scrub, !rownames(inc_scrub) %in% scrub_out)

hell_scrub <- subset(dhell_mat, rownames(dhell_mat) %in% 
                        site$sample_name[site$habitat == "Scrub"
                                         & site$year == "pan2020"])
hell_scrub <- as.matrix(hell_scrub[,colSums(hell_scrub) != 0])
hell_scrub <- subset(hell_scrub, !rownames(hell_scrub) %in% scrub_out)

# Ordination
set.seed(1)
scrub_mds_inc <- metaMDS(inc_scrub, distance = "jaccard", trymax = 1000, 
                         k = 2, noshare = TRUE)
scrub_mds_hell <- metaMDS(hell_scrub, distance = "euclidean", trymax = 1000, 
                          k = 2)

# Plot
scrub_df <- 
  as_tibble(scrub_mds_hell$points, rownames = "sample_name") %>%
  left_join(site, by = "sample_name") 

scrub_2020 <- 
  scrub_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  geom_text(aes(label = sample_name), size = 1) +
  geom_point(aes(shape = status), size = 2) +
  stat_ellipse(type = "euclid") +
  theme_minimal() 

# Distance matrix
scrub_dist <- vegdist(hell_scrub)

# PERMANOVA / PERMDISP
perm_2020 <- adonis2(scrub_dist~status, 
        site[site$sample_name %in% rownames(hell_scrub),], 
        permutations = 1000)
ano_2020 <- anosim(hell_scrub, distance = "euclidean",
       grouping = site[site$sample_name %in% rownames(hell_scrub),]$status, 
       permutations = 1000)
dispr_2020 <- anova(betadisper(scrub_dist, 
                 site$status[site$sample_name %in% rownames(hell_scrub)]))

## 2021 ##
scrub_out <- c( "pan2021_BC_S01_Unburn")

# Matrix
inc_scrub <- subset(dinc_mat, rownames(dinc_mat) %in% 
                        site$sample_name[site$habitat == "Scrub" 
                                         & site$year == "pan2021"])
inc_scrub <- as.matrix(inc_grass[,colSums(inc_grass) != 0])
inc_scrub <- subset(inc_scrub, !rownames(inc_scrub) %in% scrub_out)

hell_scrub <- subset(dhell_mat, rownames(dhell_mat) %in% 
                        site$sample_name[site$habitat == "Scrub"
                                         & site$year == "pan2021"])
hell_scrub <- as.matrix(hell_scrub[,colSums(hell_scrub) != 0])
hell_scrub <- subset(hell_scrub, !rownames(hell_scrub) %in% scrub_out)

# Ordination
set.seed(1)
scrub_mds_inc <- metaMDS(inc_scrub, distance = "jaccard", trymax = 1000, 
                         k = 2, noshare = TRUE)
scrub_mds_hell <- metaMDS(hell_scrub, distance = "euclidean", trymax = 1000, 
                          k = 2, noshare = TRUE)

# Plot
scrub_df <- 
  as_tibble(scrub_mds_hell$points, rownames = "sample_name") %>%
  left_join(site, by = "sample_name") 

scrub_2021 <- 
  scrub_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  geom_text(aes(label = sample_name), size = 1) +
  geom_point(aes(shape = status), size = 2) +
  stat_ellipse(type = "euclid") +
  theme_minimal() 

# Distance matrix
scrub_dist <- vegdist(hell_scrub)

# PERMANOVA / PERMDISP
perm_2021 <- adonis2(scrub_dist~status, 
        site[site$sample_name %in% rownames(hell_scrub),], 
        permutations = 1000)
ano_2021 <- anosim(hell_scrub, distance = "euclidean",
       grouping = site[site$sample_name %in% rownames(hell_scrub),]$status, 
       permutations = 1000)
dispr_2021 <- anova(betadisper(scrub_dist, 
                 site$status[site$sample_name %in% rownames(hell_scrub)]))

scrub <- ggpubr::ggarrange(scrub_2020, scrub_2021)
```

```{r oak nmds/permanova}
site <- sites

# pan2021_HT_G01_Burn, pan2021_AN_G05_Burn, pan2020_ML_G01_Burn
oak_out <- c( "pan2020_AN_S01_Burn", "pan2020_AN_S01_Unburn")

## 2020 ##
# Matrix
inc_oak <- subset(dinc_mat, rownames(dinc_mat) %in% 
                        site$sample_name[site$habitat == "Oak Woodland" 
                                         & site$year == "pan2020"])
inc_oak <- as.matrix(inc_oak[,colSums(inc_oak) != 0])
# inc_oak <- subset(inc_oak, !rownames(inc_oak) %in% oak_out)

hell_oak <- subset(dhell_mat, rownames(dhell_mat) %in% 
                        site$sample_name[site$habitat == "Oak Woodland"
                                         & site$year == "pan2020"])
hell_oak <- as.matrix(hell_oak[,colSums(hell_oak) != 0])
hell_oak <- subset(hell_oak, !rownames(hell_oak) %in% oak_out)

# Ordination
set.seed(1)
oak_mds_inc <- metaMDS(inc_oak, distance = "jaccard", trymax = 100, 
                         k = 2)
oak_mds_hell <- metaMDS(hell_oak, distance = "euclidean", trymax = 100, 
                          k = 2)

# Plot
oak_df <- 
  as_tibble(oak_mds_inc$points, rownames = "sample_name") %>%
  left_join(site, by = "sample_name") 

oak_2020 <- 
  oak_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  geom_text(aes(label = sample_name), size = 1) +
  geom_point(aes(shape = status), size = 2) +
  stat_ellipse(type = "euclid") +
  theme_minimal() 

# Distance matrix
oak_dist <- vegdist(hell_oak)

# PERMANOVA / PERMDISP
perm_2020 <- adonis2(oak_dist~status, 
        site[site$sample_name %in% rownames(hell_oak),], 
        permutations = 1000)
dispr_2020 <- anova(betadisper(oak_dist, 
                 site$status[site$sample_name %in% rownames(hell_oak)]))

## 2021 ##
# Matrix
inc_oak <- subset(dinc_mat, rownames(dinc_mat) %in% 
                        site$sample_name[site$habitat == "Oak Woodland" 
                                         & site$year == "pan2021"])
inc_oak <- as.matrix(inc_oak[,colSums(inc_oak) != 0])
# inc_oak <- subset(inc_oak, !rownames(inc_oak) %in% oak_out)

hell_oak <- subset(dhell_mat, rownames(dhell_mat) %in% 
                        site$sample_name[site$habitat == "Oak Woodland"
                                         & site$year == "pan2021"])
hell_oak <- as.matrix(hell_oak[,colSums(hell_oak) != 0])
hell_oak <- subset(hell_oak, !rownames(hell_oak) %in% oak_out)

# Ordination
set.seed(1)
oak_mds_inc <- metaMDS(inc_oak, distance = "jaccard", trymax = 100, 
                         k = 2)
oak_mds_hell <- metaMDS(hell_oak, distance = "euclidean", trymax = 100, 
                          k = 2, noshare = TRUE)

# Plot
oak_df <- 
  as_tibble(oak_mds_inc$points, rownames = "sample_name") %>%
  left_join(site, by = "sample_name") 

oak_2021 <- 
  oak_df %>%
  ggplot(aes(x = MDS1, y = MDS2, color = status)) + 
  geom_text(aes(label = sample_name), size = 1) +
  geom_point(aes(shape = status), size = 2) +
  stat_ellipse(type = "euclid") +
  theme_minimal() 

# Distance matrix
oak_dist <- vegdist(hell_oak)

# PERMANOVA / PERMDISP
perm_2021 <- adonis2(oak_dist~status, 
        site[site$sample_name %in% rownames(hell_oak),], 
        permutations = 1000)
dispr_2021 <- anova(betadisper(oak_dist, 
                 site$status[site$sample_name %in% rownames(hell_oak)]))

ggpubr::ggarrange(oak_2020, oak_2021)
```

```{r beta diversity by habitat}
hab_beta <- 
  beta_total %>%
  filter(habitat.x %in% 
           c("Scrub", "Grassland", "Oak Woodland")) %>%
  filter(habitat.x == habitat.y,
         year.x == year.y) %>%
  mutate(comparison = case_when(
    status.x == status.y & status.x == "Burn" ~ "Burn",
    status.x == status.y & status.x == "Unburn" ~ "Unburn",
    TRUE ~ "Between"
  )) 

beta_narrowed %>%
  filter(habitat.x != "Chamise") %>%
  ggplot(aes(status.x, value)) +
  geom_boxplot(aes(fill = status.x)) +
  geom_jitter(alpha = 0.3) +
  facet_grid(~habitat.x) +
  theme_minimal()

```
